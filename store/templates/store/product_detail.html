{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<section class="py-5 product-detail-section">
    <div class="container">
        <a href="{% url 'store:shop' %}" class="text-decoration-none text-muted small">
            ‚Üê Back to Shop
        </a>

        <div class="row g-5 mt-2 align-items-start">

            <!-- LEFT : Product Image -->
            <div class="col-md-5">
                <div class="product-image-card position-relative">

    
                    {% if product.image %}
                        <img src="{{ product.image.url }}"
                             alt="{{ product.name }}"
                             class="img-fluid rounded-4">
                    {% else %}
                        <div class="p-5 text-center text-muted">No image available</div>
                    {% endif %}
                </div>
            </div>

            <!-- RIGHT : Product Details -->
            <div class="col-md-7">
                <div class="product-info sticky-top">

                    <span class="badge bg-primary mb-2">
                        {{ product.category.name }}
                    </span>

                    <h2 class="fw-bold">{{ product.name }}</h2>

                    {% if product.model_number %}
                        <p class="text-muted mb-2">
                            Model No: <strong>{{ product.model_number }}</strong>
                        </p>
                    {% endif %}

                    <div class="price-box my-3">
                        ‚Çπ {{ product.price }}
                    </div>

                    <p class="mb-3">
                        {% if product.stock > 0 and product.is_available %}
                            <span class="badge bg-success px-3 py-2">
                                In Stock ({{ product.stock }})
                            </span>
                        {% else %}
                            <span class="badge bg-danger px-3 py-2">
                                Out of Stock
                            </span>
                        {% endif %}
                    </p>

                    <!-- Feature highlights -->
                    <div class="feature-strip mb-4">
                        <div><i class="bi bi-lightning-charge-fill"></i> High Performance</div>
                        <div><i class="bi bi-shield-check"></i> Quality Tested</div>
                        <div><i class="bi bi-truck"></i> Fast Delivery</div>
                    </div>

                    {% if product.description %}
                        <div class="product-description mb-4">
                            {{ product.description|safe }}
                        </div>
                    {% endif %}

                    <!-- Actions -->
                    {% if product.stock > 0 and product.is_available %}
                    <form method="post" action="{% url 'store:add_to_cart' product.id %}">
                        {% csrf_token %}

                        <!-- Quantity Counter -->
                        <div class="mb-3">
                            <input type="number"
                                name="quantity"
                                min="1"
                                max="{{ product.stock }}"
                                value="1"
                                class="form-control qty-input text-center">
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-btn-group">
                            <button class="btn btn-primary action-btn">
                                <i class="bi bi-cart-plus"></i>
                                Add to Cart
                            </button>

                            {% if user.is_authenticated %}
                            <button type="button"
                                    class="btn btn-outline-danger action-btn"
                                    onclick="toggleWishlist('{{ product.id }}')">
                                <i class="{% if is_in_wishlist %}fas{% else %}far{% endif %} fa-heart"></i>
                                <span class="wishlist-text">
                                    {% if is_in_wishlist %}Remove{% else %}Add to Wishlist{% endif %}
                                </span>
                            </button>
                            {% endif %}
                        </div>

                        <input type="hidden" name="next"
                            value="{% url 'store:product_detail' product.slug %}">
                    </form>
                    {% else %}
                    <button class="btn btn-secondary btn-lg mt-2" disabled>
                        Out of Stock
                    </button>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</section>


<!-- Wishlist Toggle Script -->
<script>
function toggleWishlist(productId) {

    const iconBtn = document.querySelector('.wishlist-btn i');
    const textBtn = document.querySelector('.wishlist-btn-text i');
    const textSpan = document.querySelector('.wishlist-text');

    fetch(`/wishlist/toggle/${productId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showToast('Something went wrong!');
            return;
        }

        // Toggle icons
        if (data.in_wishlist) {
            iconBtn?.classList.replace('far', 'fas');
            textBtn?.classList.replace('far', 'fas');
            if (textSpan) textSpan.innerText = 'Remove from Wishlist';
        } else {
            iconBtn?.classList.replace('fas', 'far');
            textBtn?.classList.replace('fas', 'far');
            if (textSpan) textSpan.innerText = 'Add to Wishlist';
        }

        // üî• Update wishlist count instantly
        const countElem = document.getElementById('wishlist-count');
        if (countElem) {
            countElem.innerText = data.wishlist_count;
        }

        showToast(data.message);
    })
    .catch(error => {
        console.error(error);
        showToast('Server error!');
    });
}


// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.split('=')[1]);
            }
        });
    }
    return cookieValue;
}


// Toast message
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    toast.innerHTML = `
        <div class="toast show">
            <div class="toast-body bg-white shadow rounded">
                ${message}
            </div>
        </div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 2500);
}
</script>


{% endblock %}